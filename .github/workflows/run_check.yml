name: Qatar Award Check SFO

on:
  schedule:
    - cron: '0 22,23,0,1,2,3,4 * * *'
  workflow_dispatch:

jobs:
  check-seats:
    runs-on: ubuntu-latest
    timeout-minutes: 65
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # RESTORE the state file from previous runs
      - name: Restore State
        uses: actions/cache@v3
        with:
          path: last_seen_savers.json
          # Use a dynamic key so it's unique, but falls back to the most recent 'qatar-state-'
          key: qatar-state-${{ github.run_id }}
          restore-keys: |
            qatar-state-

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests

      - name: Run search loop
        env:
          SEATS_API_KEY: ${{ secrets.SEATS_API_KEY }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: python main.py

      # SAVE the state file for the next run
      # This step always runs even if the loop finishes
      - name: Save State
        if: always()
        uses: actions/cache@v3
        with:
          path: last_seen_savers.json
          key: qatar-state-${{ github.run_id }}
